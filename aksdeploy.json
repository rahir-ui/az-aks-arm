{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"resourceName": {
			"type": "string",
			"metadata": {
				"description": "The name of the Managed Cluster resource."
			}
		},
		"location": {
			"type": "string",
			"defaultValue": "[resourceGroup().location]",
			"metadata": {
				"description": "The Azure location of the AKS resource."
			}
		},
		"dnsPrefix": {
			"type": "string",
			"metadata": {
				"description": "Optional DNS prefix to use with hosted Kubernetes API server FQDN."
			}
		},
		"osDiskSizeGB": {
			"defaultValue": 128,
			"minValue": 0,
			"maxValue": 1023,
			"type": "int",
			"metadata": {
				"description": "Disk size (in GB) to provision for each of the agent pool nodes. This value ranges from 0 to 1023. Specifying 0 will apply the default disk size for that agentVMSize."
			}
		},
		"agentCount": {
			"defaultValue": 3,
			"minValue": 1,
			"maxValue": 100,
			"type": "int",
			"metadata": {
				"description": "The number of agent nodes for the cluster. Production workloads have a recommended minimum of 3."
			}
		},
		"agentVMSize": {
			"defaultValue": "Standard_D2s_v3",
			"type": "string",
			"metadata": {
				"description": "The size of the Virtual Machine."
			}
		},
		"osType": {
			"defaultValue": "Linux",
			"allowedValues": [
				"Linux",
				"Windows"
			],
			"type": "string",
			"metadata": {
				"description": "The type of operating system."
			}
		},
		"kubernetesVersion": {
			"defaultValue": "1.22.11",
			"allowedValues": [
				"1.21.9",
				"1.21.14",
				"1.22.6",
				"1.22.11",
				"1.23.5",
				"1.23.8"
			],
			"type": "string",
			"metadata": {
				"description": "The version of Kubernetes."
			}
		},
		"enableHttpApplicationRouting": {
			"defaultValue": false,
			"type": "bool",
			"metadata": {
				"description": "boolean flag to turn on and off of http application routing"
			}
		},
		"networkPlugin": {
			"allowedValues": [
				"azure",
				"kubenet"
			],
			"defaultValue": "azure",
			"type": "string",
			"metadata": {
				"description": "Network plugin used for building Kubernetes network."
			}
		},
		"networkPolicy": {
			"allowedValues": [
				"azure",
				"calico",
				"none"
			],
			"defaultValue": "azure",
			"type": "string",
			"metadata": {
				"description": "Network policies allow you to define rules for ingress and egress traffic between pods."
			}
		},
		"maxPods": {
			"defaultValue": 30,
			"type": "int",
			"metadata": {
				"description": "Maximum number of pods that can run on a node."
			}
		},
		"existingVirtualNetworkResourceGroup": {
			"type": "string",
			"metadata": {
				"description": "Name of the existing VNET resource group"
			}
		},
		"existingVirtualNetworkName": {
			"type": "string",
			"metadata": {
				"description": "Name of an existing VNET that will contain this AKS deployment."
			}
		},
		"existingSubnetName": {
			"type": "string",
			"metadata": {
				"description": "Subnet name that will contain the App Service Environment"
			}
		},
		"adminGroups": {
			"type": "array",
			"metadata": {
				"description": "AAD group object ids which should be added to the Kubernetes cluster-admin role"
			},
			"defaultValue": []
		},
		"serviceCidr": {
			"type": "string",
			"defaultValue": "10.0.0.0/16",
			"metadata": {
				"description": "A CIDR notation IP range from which to assign service cluster IPs."
			}
		},
		"dnsServiceIP": {
			"type": "string",
			"defaultValue": "10.0.0.10",
			"metadata": {
				"description": "Containers DNS server IP address."
			}
		},
		"dockerBridgeCidr": {
			"type": "string",
			"defaultValue": "172.17.0.1/16",
			"metadata": {
				"description": "A CIDR notation IP for Docker bridge."
			}
		},
		"aksPolicy": {
			"type": "bool",
			"metadata": {
				"description": "Enable the AKS Azure Policy add-on"
			},
			"defaultValue": false
		},
		"controlPlaneSku": {
			"type": "string",
			"metadata": {
				"description": "Free or SLA covered control plane mode"
			},
			"allowedValues": [
				"Free",
				"Paid"
			],
			"defaultValue": "Free"
		}
	},
	"variables": {
		"apiVersion": {
			"aks": "2022-06-01",
			"rbac": "2020-04-01-preview",
			"deployments": "2020-06-01"
		},
		"agentPoolProfiles": {
			"vnetSubnetId": "[concat(resourceId(parameters('existingVirtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks', parameters('existingVirtualNetworkName')), '/subnets/', parameters('existingSubnetName'))]"
		},
		"outputs": {
			"resourceId": "[resourceId('Microsoft.ContainerService/managedClusters/' ,parameters('resourceName'))]"
		}
	},
	"resources": [
		{
			"type": "Microsoft.ContainerService/managedClusters",
			"name": "[parameters('resourceName')]",
			"apiVersion": "2022-06-01",
			"location": "[parameters('location')]",
			"identity": {
				"type": "SystemAssigned"
			},
			"sku": {
				"name": "Basic",
				"tier": "[parameters('controlPlaneSku')]"
			},
			"properties": {
				"kubernetesVersion": "[parameters('kubernetesVersion')]",
				"enableRBAC": true,
				"dnsPrefix": "[parameters('dnsPrefix')]",
				"aadProfile": {
					"managed": true,
					"adminGroupObjectIDs": "[parameters('adminGroups')]",
					"tenantID": "fc8e13c0-422c-4c55-b3ea-ca318e6cac32"
				},
				"addonProfiles": {
					"httpApplicationRouting": {
						"enabled": "[parameters('enableHttpApplicationRouting')]"
					},
					"azurepolicy": {
						"enabled": "[parameters('aksPolicy')]",
						"config": {
							"version": "v2"
						}
					}
				},
				"agentPoolProfiles": [
					{
						"name": "agentpool",
						"osDiskSizeGB": "[parameters('osDiskSizeGB')]",
						"count": "[parameters('agentCount')]",
						"vmSize": "[parameters('agentVMSize')]",
						"osType": "[parameters('osType')]",
						"osDiskType": "Managed",
						"storageProfile": "ManagedDisks",
						"vnetSubnetID": "[variables('agentPoolProfiles').vnetSubnetId]",
						"maxPods": "[parameters('maxPods')]",
						"type": "VirtualMachineScaleSets",
						"enableAutoScaling": false,
						"orchestratorVersion": "1.22.11",
						"enableNodePublicIP": false,
						"mode": "System"
					}
				],
				"networkProfile": {
					"networkPlugin": "[parameters('networkPlugin')]",
					"networkPolicy": "[parameters('networkPolicy')]",
					"loadBalancerSku": "Standard",
					"serviceCidr": "[parameters('serviceCidr')]",
					"dnsServiceIP": "[parameters('dnsServiceIP')]",
					"dockerBridgeCidr": "[parameters('dockerBridgeCidr')]",
					"outboundType": "userDefinedRouting"
				},
				"apiServerAccessProfile": {
					"enablePrivateCluster": true,
					"enablePrivateClusterPublicFQDN": true
				}
			}
		}
	]
}
